using System;
using System.Data;
using System.Linq;
using System.Windows.Forms;
using Microsoft.Reporting.WinForms;
using Microsoft.EntityFrameworkCore;
using Gestion_Cursos.Data;   // Para acceder a tu DbContext
using Gestion_Cursos.Views.Reportes; // Para acceder a tu ds_cursos (si está en esa carpeta)

namespace Gestion_Cursos_Copia.Views.Reportes
{
    public partial class frm_reporte_Cursos_Est : Form
    {
        public frm_reporte_Cursos_Est()
        {
            InitializeComponent();
        }

        private void frm_reporte_Cursos_Est_Load(object sender, EventArgs e)
        {
            try
            {
                // 1. Obtener los datos usando tu DbContext
                using (var db = new Gestion_Curso_DbContext())
                {
                    // Nota: Entity Framework a veces genera nombres como "Inscripcione" (con e al final)
                    var listaDatos = db.Inscripciones
                        .Include(i => i.Estudiante)
                        .Include(i => i.Curso)
                            .ThenInclude(c => c.Profesor) // Bajamos al profesor del curso
                        .Select(i => new
                        {
                            NombreEst = i.Estudiante.Nombre + " " + i.Estudiante.Apellido,
                            CedulaEst = i.Estudiante.Cedula,
                            NombreCur = i.Curso.NombreCurso,
                            // Accedemos a la entidad 'Profesore'
                            NombreProf = i.Curso.Profesor.Nombre + " " + i.Curso.Profesor.Apellido,
                            Fecha = i.FechaInscripcion
                        })
                        .ToList();

                    // 2. Llenar el DataSet Tipado (tu molde)
                    // Como el archivo está en la carpeta Reportes, se llama igual que el namespace
                    ds_cursos datosReporte = new ds_cursos();

                    // Limpiamos la tabla por si acaso
                    datosReporte.dtCursos.Clear();

                    foreach (var item in listaDatos)
                    {
                        // Convertimos la fecha a string aquí para que se vea bonita
                        string fechaString = item.Fecha.HasValue ? item.Fecha.Value.ToShortDateString() : "N/A";

                        // Agregamos la fila al DataSet
                        datosReporte.dtCursos.AdddtCursosRow(
                            item.NombreEst,
                            item.CedulaEst,
                            item.NombreCur,
                            item.NombreProf,
                            fechaString
                        );
                    }

                    // 3. Conectar al ReportViewer
                    this.reportViewer1.LocalReport.DataSources.Clear();

                    // "dts_Cursos" debe ser IGUAL al nombre que pusiste en el diseño del RDLC
                    ReportDataSource rds = new ReportDataSource("dts_Cursos", datosReporte.Tables["dtCursos"]);

                    this.reportViewer1.LocalReport.DataSources.Add(rds);
                    this.reportViewer1.RefreshReport();
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show("Error al cargar el reporte: " + ex.Message);
            }
        }
    }
}
