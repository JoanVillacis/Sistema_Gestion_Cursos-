using Gestion_Cursos.Data;
using Gestion_Cursos.Models;
using Microsoft.EntityFrameworkCore;
using System;
using System.Linq;
using System.Windows.Forms;

namespace Gestion_Cursos.Controllers
{
    public class Login_Controller
    {
        private readonly Gestion_Curso_DbContext _authDb = new Gestion_Curso_DbContext();

        public Credenciale login(Credenciale cred)
        {
            if (cred == null) return null;
            if (string.IsNullOrWhiteSpace(cred.Correo) || string.IsNullOrWhiteSpace(cred.Contrasenia))
                return null;

            try
            {
                // Buscar credencial por correo y contraseña y que el usuario asociado esté activo
                var credencial = _authDb.Credenciales
                    .Include(c => c.Usuario)
                    .AsNoTracking()
                    .FirstOrDefault(c => c.Correo == cred.Correo
                    && c.Contrasenia == cred.Contrasenia
                    && c.Usuario != null
                    && c.Usuario.Estado == true);

                return credencial;
            }
            catch (Exception ex)
            {
                var msg = ex.InnerException?.Message ?? ex.Message;
                MessageBox.Show(msg, "Error al iniciar sesión", MessageBoxButtons.OK, MessageBoxIcon.Error);
                return null;
            }
        }
    }
}
