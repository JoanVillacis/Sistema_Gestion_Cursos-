using Gestion_Cursos.Data;
using Gestion_Cursos.Models;
using Microsoft.EntityFrameworkCore;
using System;
using System.Linq;
using System.Windows.Forms;

namespace Gestion_Cursos.Controllers
{
    public class Auth_Controller
    {
        private readonly Gestion_Curso_DbContext _auth_DbContext = new Gestion_Curso_DbContext();

        public Credenciale login(Credenciale cred)
        {
            if (cred == null) return null;
            if (string.IsNullOrWhiteSpace(cred.Correo) || string.IsNullOrWhiteSpace(cred.Contrasenia))
                return null;

            try
            {
                // Buscar cred por correo y contraseña y que el usuario asociado esté activo
                var credencial = _auth_DbContext.Credenciales
                    .Include(c => c.Usuario)
                    .AsNoTracking()
                    .FirstOrDefault(c => c.Correo == cred.Correo
                    && c.Contrasenia == cred.Contrasenia
                    && c.Usuario != null
                    && c.Usuario.Estado == true);

                return credencial;
            }
            catch (Exception ex)
            {
                var msg = ex.InnerException?.Message ?? ex.Message;
                MessageBox.Show(msg, "Error al iniciar sesión", MessageBoxButtons.OK, MessageBoxIcon.Error);
                return null;
            }
        }
        public string insertar(Credenciale cred)
        {
            if (cred == null)
            {
                return "Debe completar las cajas de texto para guardar las credenciales";
            }
            else
            {
                try
                {
                    _auth_DbContext.Credenciales.Add(cred);
                    _auth_DbContext.SaveChanges();
                    return "ok";
                }
                catch (Exception ex)
                {
                    var msg = ex.InnerException?.Message ?? ex.Message;
                    return msg;
                }
            }
        }
        public string editar(Credenciale cred)
        {
            if (cred == null)
            {
                return "Debe completar las cajas de texto para actualizar las credenciales";
            }
            try
            {
                var existente = _auth_DbContext.Credenciales.FirstOrDefault(c => c.CredencialId == cred.CredencialId);
                if (existente == null)
                {
                    return "No se encontró la cred para actualizar";
                }
                // Actualizar campos
                existente.Correo = cred.Correo;
                existente.Contrasenia = cred.Contrasenia;
                existente.Rol = cred.Rol;
                _auth_DbContext.SaveChanges();
                return "ok";
            }
            catch (Exception ex)
            {
                var msg = ex.InnerException?.Message ?? ex.Message;
                return msg;
            }
        }
        public bool VerificaCedula(char[] validarCedula)
        {
            if (validarCedula == null || validarCedula.Length < 10)
                return false;

            for (int i = 0; i < 10; i++)
            {
                if (!char.IsDigit(validarCedula[i]))
                    return false;
            }

            int aux = 0, par = 0, impar = 0, verifi;
            for (int i = 0; i < 9; i += 2)
            {
                aux = 2 * int.Parse(validarCedula[i].ToString());
                if (aux > 9)
                    aux -= 9;
                par += aux;
            }
            for (int i = 1; i < 9; i += 2)
            {
                impar += int.Parse(validarCedula[i].ToString());
            }

            aux = par + impar;
            if (aux % 10 != 0)
            {
                verifi = 10 - (aux % 10);
            }
            else
                verifi = 0;
            if (verifi == int.Parse(validarCedula[9].ToString()))
                return true;
            else
                return false;
        }
    }
}
