using Gestion_Cursos.Controllers;
using Gestion_Cursos.Models;
using System;
using System.Linq;
using System.Windows.Forms;

namespace Gestion_Cursos.Views.Cursos
{
    public partial class frm_editar_Curso : Form
    {
        private readonly Curso_Controller _cursoController = new Curso_Controller();
        private readonly Profesor_Controller _profesorController = new Profesor_Controller();
        private int _id;

        public frm_editar_Curso(int id)
        {
            InitializeComponent();
            _id = id;
            CargarHorarios();
            CargarProfesores();
            CargarCurso();
        }

        private void CargarHorarios()
        {
            cmb_Horario.Items.Clear();
            cmb_Horario.Items.Add("Lun-Mie18:00-20:00");
            cmb_Horario.Items.Add("Mar-Jue19:00-21:00");
            cmb_Horario.Items.Add("Sábados08:00-10:00");
            cmb_Horario.Items.Add("Lun-Vie07:00-09:00");
            cmb_Horario.Items.Add("Mar-Jue10:00-12:00");
            cmb_Horario.Items.Add("Lun-Mie17:00-19:00");
            cmb_Horario.Items.Add("Vie18:00-21:00");
            cmb_Horario.Items.Add("Sábados14:00-18:00");
            cmb_Horario.Items.Add("Lun-Vie20:00-22:00");
            if (cmb_Horario.Items.Count > 0) cmb_Horario.SelectedIndex = -1;
        }

        private void CargarProfesores()
        {
            try
            {
                var lista = _profesorController.todos()
                    .Select(p => new { p.ProfesorId, Nombre = string.Concat(p.Nombre, " ", p.Apellido).Trim() })
                    .ToList();
                cmb_Profesor.DataSource = lista;
                cmb_Profesor.ValueMember = "ProfesorId";
                cmb_Profesor.DisplayMember = "Nombre";
                cmb_Profesor.SelectedIndex = -1;
            }
            catch
            {
                cmb_Profesor.Items.Clear();
            }
        }

        public void CargarCurso()
        {
            var curso = _cursoController.uno(_id);
            if (curso == null)
            {
                MessageBox.Show("Curso no encontrado", "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
                this.Close();
                return;
            }
            txt_Nombres.Text = curso.NombreCurso;
            txt_Apellidos.Text = curso.Descripcion;
            if (!string.IsNullOrWhiteSpace(curso.Horario) && cmb_Horario.Items.Contains(curso.Horario)) cmb_Horario.SelectedItem = curso.Horario;
            if (curso.Profesor != null && cmb_Profesor.Items.Count > 0)
            {
                cmb_Profesor.SelectedValue = curso.ProfesorId;
            }
        }

        private void btn_Guardar_Click(object sender, EventArgs e)
        {
            if (string.IsNullOrWhiteSpace(txt_Nombres.Text))
            {
                MessageBox.Show("Debe ingresar el nombre del curso", "Datos incompletos", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return;
            }
            if (string.IsNullOrWhiteSpace(txt_Apellidos.Text))
            {
                MessageBox.Show("Debe ingresar la descripción del curso", "Datos incompletos", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return;
            }
            if (cmb_Horario.SelectedItem == null)
            {
                MessageBox.Show("Seleccione un horario", "Datos incompletos", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return;
            }
            if (cmb_Profesor.SelectedItem == null)
            {
                MessageBox.Show("Seleccione un profesor para el curso", "Datos incompletos", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return;
            }
            var profesorId = (int)cmb_Profesor.SelectedValue;
            var curso = new Curso
            {
                CursoId = _id,
                NombreCurso = txt_Nombres.Text.Trim(),
                Descripcion = txt_Apellidos.Text.Trim(),
                Horario = cmb_Horario.SelectedItem.ToString(),
                ProfesorId = profesorId,
                Estado = true
            };
            var res = _cursoController.actualizar(curso);
            if (res == "ok")
            {
                MessageBox.Show("Curso actualizado correctamente.", "Información", MessageBoxButtons.OK, MessageBoxIcon.Information);
                this.DialogResult = DialogResult.OK;
                this.Close();
            }
            else
            {
                MessageBox.Show(res, "Error al actualizar", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        private void btn_Cancelar_Click(object sender, EventArgs e)
        {
            CargarCurso();
        }

        private void btn_Salir_Click(object sender, EventArgs e)
        {
            this.Close();
        }

        private void txt_Nombres_Leave(object sender, EventArgs e)
        {
            if (string.IsNullOrWhiteSpace(txt_Nombres.Text)) return;
            if (_cursoController.NombreExists(txt_Nombres.Text.Trim()))
            {
                MessageBox.Show("Ya existe un curso con ese nombre", "Nombre duplicado", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                txt_Nombres.Focus();
            }
        }
    }
}
