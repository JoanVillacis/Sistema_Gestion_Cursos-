using Gestion_Cursos.Data;
using Gestion_Cursos.Models;
using Microsoft.EntityFrameworkCore;
using System;
using System.Linq;
using System.Windows.Forms;

namespace Gestion_Cursos.Controllers
{
    public class Auth_Controller
    {
        private readonly Gestion_Curso_DbContext _auth_DbContext = new Gestion_Curso_DbContext();

        public Credenciale login(Credenciale cred)
        {
            if (cred == null) return null;
            if (string.IsNullOrWhiteSpace(cred.Correo) || string.IsNullOrWhiteSpace(cred.Contrasenia))
                return null;

            try
            {
                var credencial = _auth_DbContext.Credenciales
                    .Include(c => c.Usuario)
                    .AsNoTracking()
                    .FirstOrDefault(c => c.Correo == cred.Correo
                    && c.Contrasenia == cred.Contrasenia
                    && c.Usuario != null
                    && c.Usuario.Estado == true);

                return credencial;
            }
            catch (Exception ex)
            {
                var msg = ex.InnerException?.Message ?? ex.Message;
                MessageBox.Show(msg, "Error al iniciar sesión", MessageBoxButtons.OK, MessageBoxIcon.Error);
                return null;
            }
        }
        public string insertar(Credenciale cred)
        {
            if (cred == null)
            {
                return "Debe completar las cajas de texto para guardar las credenciales";
            }
            else
            {
                try
                {
                    _auth_DbContext.Credenciales.Add(cred);
                    _auth_DbContext.SaveChanges();
                    return "ok";
                }
                catch (Exception ex)
                {
                    var msg = ex.InnerException?.Message ?? ex.Message;
                    return msg;
                }
            }
        }
        public string editar(Credenciale cred)
        {
            if (cred == null)
            {
                return "Debe completar las cajas de texto para actualizar las credenciales";
            }
            try
            {
                var existente = _auth_DbContext.Credenciales.FirstOrDefault(c => c.CredencialId == cred.CredencialId);
                if (existente == null)
                {
                    return "No se encontró la cred para actualizar";
                }
                existente.Correo = cred.Correo;
                existente.Contrasenia = cred.Contrasenia;
                existente.Rol = cred.Rol;
                _auth_DbContext.SaveChanges();
                return "ok";
            }
            catch (Exception ex)
            {
                var msg = ex.InnerException?.Message ?? ex.Message;
                return msg;
            }
        }
        public bool VerificaCedula(char[] validarCedula)
        {
            if (validarCedula == null || validarCedula.Length !=10) return false;

            try
            {
                int[] dig = new int[10];
                for (int i =0; i <10; i++) dig[i] = validarCedula[i] - '0';

                int suma =0;
                for (int i =0; i <9; i++)
                {
                    int val = dig[i] * (i %2 ==0 ?2 :1);
                    if (val >9) val -=9;
                    suma += val;
                }

                int ultimo = (10 - (suma %10)) %10;
                return ultimo == dig[9];
            }
            catch
            {
                return false;
            }
        }
    }
}
