using Gestion_Cursos.Controllers;
using Gestion_Cursos.Models;
using System;
using System.Linq;
using System.Windows.Forms;

namespace Gestion_Cursos.Views.Cursos
{
    public partial class frm_agregar_Curso : Form
    {
        private readonly Curso_Controller _cursoController = new Curso_Controller();
        private readonly Profesor_Controller _profesorController = new Profesor_Controller();

        public frm_agregar_Curso()
        {
            InitializeComponent();
            CargarHorarios();
            CargarProfesores();
        }

        private void CargarHorarios()
        {
            cmb_Horario.Items.Clear();
            // Lista de horarios basados en la imagen y ejemplos
            cmb_Horario.Items.Add("Lun-Mie18:00-20:00");
            cmb_Horario.Items.Add("Mar-Jue19:00-21:00");
            cmb_Horario.Items.Add("Sábados08:00-10:00");
            cmb_Horario.Items.Add("Lun-Vie07:00-09:00");
            cmb_Horario.Items.Add("Mar-Jue10:00-12:00");
            cmb_Horario.Items.Add("Lun-Mie17:00-19:00");
            cmb_Horario.Items.Add("Vie18:00-21:00");
            cmb_Horario.Items.Add("Sábados14:00-18:00");
            cmb_Horario.Items.Add("Lun-Vie20:00-22:00");
            if (cmb_Horario.Items.Count >0) cmb_Horario.SelectedIndex = -1;
        }

        private void CargarProfesores()
        {
            try
            {
                var lista = _profesorController.todos()
                    .Select(p => new { p.ProfesorId, Nombre = string.Concat(p.Nombre, " ", p.Apellido).Trim() })
                    .ToList();
                cmb_Profesor.DataSource = lista;
                cmb_Profesor.ValueMember = "ProfesorId";
                cmb_Profesor.DisplayMember = "Nombre";
                cmb_Profesor.SelectedIndex = -1;
            }
            catch
            {
                // fallback: dejar vacío
                cmb_Profesor.Items.Clear();
            }
        }

        private void frm_agregar_Curso_Load(object sender, EventArgs e)
        {

        }

        private void btn_Guardar_Click(object sender, EventArgs e)
        {
            if (string.IsNullOrWhiteSpace(txt_Nombres.Text))
            {
                MessageBox.Show("Debe ingresar el nombre del curso", "Datos incompletos", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return;
            }

            if (string.IsNullOrWhiteSpace(txt_Apellidos.Text))
            {
                MessageBox.Show("Debe ingresar la descripción del curso", "Datos incompletos", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return;
            }

            if (cmb_Horario.SelectedItem == null)
            {
                MessageBox.Show("Seleccione un horario", "Datos incompletos", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return;
            }

            if (cmb_Profesor.SelectedItem == null)
            {
                MessageBox.Show("Seleccione un profesor para el curso", "Datos incompletos", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return;
            }

            var profesorId = (int)cmb_Profesor.SelectedValue;

            var curso = new Curso
            {
                NombreCurso = txt_Nombres.Text.Trim(),
                Descripcion = txt_Apellidos.Text.Trim(),
                Horario = cmb_Horario.SelectedItem.ToString(),
                ProfesorId = profesorId,
                Estado = true
            };

            var res = _cursoController.insertar(curso);
            if (res == "ok")
            {
                MessageBox.Show("Curso guardado correctamente.", "Información", MessageBoxButtons.OK, MessageBoxIcon.Information);
                this.DialogResult = DialogResult.OK;
                this.Close();
            }
            else
            {
                MessageBox.Show(res, "Error al guardar", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        private void btn_Cancelar_Click(object sender, EventArgs e)
        {
            txt_Nombres.Text = string.Empty;
            txt_Apellidos.Text = string.Empty;
            if (cmb_Horario.Items.Count >0) cmb_Horario.SelectedIndex = -1;
            if (cmb_Profesor.Items.Count >0) cmb_Profesor.SelectedIndex = -1;
        }

        private void btn_Salir_Click(object sender, EventArgs e)
        {
            this.Close();
        }

        private void txt_Nombres_Leave(object sender, EventArgs e)
        {
            // Validación opcional del nombre
            if (string.IsNullOrWhiteSpace(txt_Nombres.Text)) return;
            if (_cursoController.NombreExists(txt_Nombres.Text.Trim()))
            {
                MessageBox.Show("Ya existe un curso con ese nombre", "Nombre duplicado", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                txt_Nombres.Focus();
            }
        }
    }
}
